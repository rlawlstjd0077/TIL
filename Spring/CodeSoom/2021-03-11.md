# 2021-03-11

# ëŠë‚€ì 

- ì‘ì—…ì„ í•˜ê±°ë‚˜ í•™ìŠµì„ í•˜ë˜ì§€ ë­”ê°€ì— í‘¹ ë¹ ì§€ê³  ë‚œ ë’¤ì—ëŠ” ì•„ë“œë ˆë‚ ë¦°ì´ ë¬´ì²™ì´ë‚˜ ë¿œë¿œ í•˜ëŠ” ê²ƒ ê°™ë‹¤.
  - ë¬¼ë¡  ê¸°ë¶„ì€ ì¢‹ì§€ë§Œ ì´ì„±ì ì´ì§€ê°€ ëª»í•˜ë‹ˆ ë­˜í•´ì•¼ ë ì§€ë¥¼ ëª¨ë¥´ê² ëŠ” ìƒí™©ì´ ëŒ€ë¶€ë¶„ì¸ ê²ƒ ê°™ë‹¤.
  - ì² ì €í•œ ë§¤ë‰´ì–¼ì´ í•„ìš”í•  ê²ƒ ê°™ë‹¤. ê°•ì œí•´ì•¼ í•œë‹¤ !
- ì•„ì˜ˆ ìƒíŒ ëª¨ë¥´ëŠ” ì£¼ì œì— ëŒ€í•´ì„œ ê³µë¶€ë¥¼ í•˜ê²Œ ë˜ë‹ˆ ì•„ì˜ˆ ëª¨ë¥´ë‹ˆ ì´ê²ƒì €ê²ƒ ì°¾ì•„ë³´ê²Œ ë˜ê³  ë” í™•ì‹¤í•˜ê²Œ ì´í•´ë¥¼ í•˜ë ¤ê³  ì‹œë„ í•˜ëŠ” ê²ƒ ê°™ë‹¤!
  - ì´ëŸ° ëŠë‚Œì„ ì´ë¯¸ ì•„ëŠ” ì§€ì‹ ë“¤ì— ëŒ€í•´ì„œë„ ì ìš©í•  ìˆ˜ ìˆìœ¼ë©´ ì¢‹ìœ¼ë ¨ë§Œ ...

# ë°°ìš´ê²ƒ

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹°

### ê¶Œí•œ

- ì–´ë–¤ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ ì œí•œ, ëª¨ë“  ë¦¬ì†ŒìŠ¤ëŠ” ì ‘ê·¼ ì œì–´ ê¶Œí•œì´ ê±¸ë ¤ìˆë‹¤.
- ì¸ê°€ ê³¼ì •ì—ì„œ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì œí•œëœ ìµœì†Œí•œì˜ ê¶Œí•˜ë‚˜ì„ ê°€ì¡ŒëŠ”ì§€ í™•ì¸í•œë‹¤.

## AuthenticationProvider

- ì‹¤ì œ ì¸ì¦(ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€)ì„ ìˆ˜í–‰í•˜ëŠ” í´ë˜ìŠ¤
- ê¸°ë³¸ìœ¼ë¡œëŠ” DaoAuthenticationProvider ì´ê³  UserDetailsService ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ UserDeailes ì¸í„°í˜ì´ìŠ¤ë¥¼ ì–»ì–´ì™€ ì¸ì¦ì„ ìˆ˜í–‰í•œë‹¤.
- authenticationEntryPoint()ëŠ” í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì—†ëŠ”ë°(SecurityContextì— ì¸ì¦ì‚¬ìš©ìê°€ ë‹´ê¸°ì§€ ì•ŠìŒ) ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ì˜€ì„ ë•Œ, ìˆ˜í–‰ë˜ëŠ” í•¸ë“¤ëŸ¬(EntryPoint)ë¥¼ ë“±ë¡í•´ì¤€ë‹¤.

## Spring Security Filter Chain

- Spring Securityì˜ ë³´ì•ˆ ì§€ì›ì€ **Servlet Filter** ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
- Spring Security Filter Chainì€ Servlet Chain ì¤‘ í•˜ë‚˜ì˜ Chain ì´ë©° Security Filter Chain ì•ˆì—ëŠ” ë‹¤ì‹œ ì—¬ëŸ¬ Security Filter ë“¤ì´ Chainì„ ì´ë£¨ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.
  - ì•„ë˜ ê·¸ë¦¼ì„ ë³´ì‹œë©´ ì´í•´ê°€ ì‰¬ìš¸ ê²ƒì…ë‹ˆë‹¤ ..

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/24f44026-cdb6-4e64-b4a0-277402b7bed2/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/24f44026-cdb6-4e64-b4a0-277402b7bed2/Untitled.png)

- Springì—ì„œëŠ” Servlet Container Lifecycle(web.xml)ê³¼ ApplicationContext ì‚¬ì´ë¥¼ ì—°ê²°í•  ìˆ˜ ìˆëŠ” `DelegatingFilterProxy` ë¼ëŠ” Filterë¥¼ ì œê³µí•©ë‹ˆë‹¤.

- ì‹¤ì œë¡œëŠ” 

  ```
  DelegatingFilterProxy
  ```

   ê°€ ê°ì‹¸ê³  ìˆëŠ” 

  ```
  FilterChainProxy
  ```

   ì— ì˜í•´ì„œ ìˆ˜í–‰ë˜ë©° 

  ```
  FilterChainProxy
  ```

   ëŠ” Security Filter Chain ì„ ê°€ì§€ê³  ì´ìˆìœ¼ë©´ì„œ ì´ë“¤ì„ ìˆœíšŒí•˜ë©´ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.

  - ê·¸ë ‡ìŠµë‹ˆë‹¤. ì € `SecutiryFilterChain`  ì¤‘ê°„ì—ëŠ” ì œê°€ ì„ ì–¸í•œ `JwtAuthenticationFilter` ë„ ìˆìŠµë‹ˆë‹¤ !

### Codeë¥¼ ë³´ì.

- ì € ë§ë§Œ ë´ì„œëŠ” ì˜ ì™€ë‹¿ì§ˆ ì•ŠìŠµë‹ˆë‹¤. (ì œê°€ ì¼ëŠ”ë° ì € ì¡°ì°¨ë„ ì´í•´ê°€ ì•ˆë©ë‹ˆë‹¤ .. ğŸ˜‚)
- ì œ `JwtAuthenticationFilter` ì˜ `doFilter()` ë©”ì„œë“œì— ë””ë²„ê¹…ì„ ê±¸ì–´ë³´ì£ .

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f0327f6a-af46-43c1-b355-fc5861d47a9f/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f0327f6a-af46-43c1-b355-fc5861d47a9f/Untitled.png)

- ê·¸ëŸ°ë‹¤ìŒ íŒŒë¼ë¯¸í„° `chain` ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

- ìš°ì„  

  ```
  chain
  ```

   ì¸ìŠ¤í„´ìŠ¤ëŠ” 

  ```
  FilterChainProxy
  ```

   ì¸ìŠ¤í„´ìŠ¤ì„ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  - ì € ìœ„ì˜ ê·¸ë¦¼ì— `SecurityFilterChain` ì„ ë“¤ê³  ìˆëŠ” ë…€ì„ì´ì£ 

- ê·¸ë¦¬ê³ 

  ```
  originalChain
  ```

   ì€ Servlet ìì²´ì˜ í•„í„° Chainì„ ë§í•˜ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.

  - Chain ì•ˆì„ ë“¤ì—¬ë‹¤ ë³´ë©´ `DelegatingFilterProxy` ê°€ 3ë²ˆ ì¸ë±ìŠ¤ì— ìœ„ì¹˜í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ !
  - ì € ìœ„ì— `FilterChainProxy` ì„ ë“¤ê³  ìˆëŠ” ë…€ì„ì´ì£ 

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/487b3840-efe6-45fd-9b1c-4dcc49356378/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/487b3840-efe6-45fd-9b1c-4dcc49356378/Untitled.png)

- `chain` ì´ `FilterProxy` ì¸ìŠ¤í„´ìŠ¤ë¼ê³  í•˜ë©´ Security Filter Chainì„ ê°€ì§€ê³  ìˆê² ì£  ?
- `chain` ì˜ `additionalFilters` í•„ë“œë¥¼ ë³´ë©´ ì œê°€ ì¶”ê°€í•œ `JwtAuthenticationFilter` ê°€ 6ë²ˆ ì¸ë±ìŠ¤ì— ìœ„ì¹˜í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7df33f9f-f901-4eb2-8fc4-844109b37748/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7df33f9f-f901-4eb2-8fc4-844109b37748/Untitled.png)

- ê·¸ëŸ°ë° ê°€ë§Œë³´ë©´ 

  ```
  chain
  ```

   ì´ 

  ```
  FilterChainProxy
  ```

   ì˜ 

  ```
  VirtualFilterChain
  ```

   ì¸ìŠ¤í„´ìŠ¤ë¼ê³  ì´ì•¼ê¸° í•˜ê³  ìˆìŠµë‹ˆë‹¤.

  - í•œë²ˆ ê°€ë³´ì£ .

- `VirtualFilterChain` ì€  `FilterChainProxy` í´ë˜ìŠ¤ì˜ ì´ë„ˆ í´ë˜ìŠ¤ë¡œ ì„ ì–¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/15f1703b-17fc-4e90-ba81-c5cea05185c6/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/15f1703b-17fc-4e90-ba81-c5cea05185c6/Untitled.png)

- `FilterChainProxy` ê°€ `VirtualFilterChain` ì„ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ì§€ ë³´ë©´ ëª…í™•í•©ë‹ˆë‹¤.

- ```
  FilterChainProxy
  ```

   ìì²´ë„ Filter ì´ê¸° ë•Œë¬¸ì—(

  ```
  GenericFilterBean
  ```

   ì˜ êµ¬í˜„ì²´) 

  ```
  doFilter()
  ```

   ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.

  - `doFilter()` ëŠ” `DelegatingFilterProxy` ì—ì„œ í˜¸ì¶œí•˜ì£ 

- ì¤‘ìš”í•œ ë¶€ë¶„ì€ `doFilterInternal()` ë©”ì„œë“œ í˜¸ì¶œì…ë‹ˆë‹¤.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/12fd509f-1dad-40ca-84d0-65fd1f45ab3f/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/12fd509f-1dad-40ca-84d0-65fd1f45ab3f/Untitled.png)

- ë©”ì„œë“œ í•˜ë‹¨ì„ ë³´ë©´ 

  ```
  VirtualFilterChain
  ```

   ê°ì²´ë¥¼ ìƒì„±í•˜ê³  

  ```
  doFilter
  ```

   ë¥¼ ì‹¤í–‰í•´ì¤ë‹ˆë‹¤.

  - ì´ë•Œ filter ëª©ë¡ì„ ë„£ì–´ì£¼ëŠ” ê²ƒ ê°™ë„¤ìš”

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/892f3e2a-dd26-499e-b7af-1f269dd5bf41/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/892f3e2a-dd26-499e-b7af-1f269dd5bf41/Untitled.png)

- ì´ì œ ëª¨ë“  ë¹„ë°€ì´ í’€ë¦° ê²ƒ ê°™ìŠµë‹ˆë‹¤ !
- ì£¼ì…ë°›ì€ filter list (Security Filter Chain) ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ì¤ë‹ˆë‹¤.
  - ì—¬ê¸°ì„œ ì œê°€ ì„ ì–¸í•œ `JwtAuthenticationFilter` ê°€ ì¤‘ê°„ì— ì‹¤í–‰ë©ë‹ˆë‹¤
- ê·¸ë¦¬ê³  filterë¥¼ ì „ë¶€ ìˆœíšŒí•œ ê²½ìš° (`currentPosition == size`) `originalChain` (Servlet Filter Chain) ì˜ ë‹¤ìŒ Filterë¥¼ í˜¸ì¶œ í•©ë‹ˆë‹¤.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d9d5df54-1fa4-4c38-ad5c-9c3ae9b2f073/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d9d5df54-1fa4-4c38-ad5c-9c3ae9b2f073/Untitled.png)

## Spring Security Filter Chain ì¶œë ¥í•˜ëŠ” ë°©ë²•

- ì½˜ì†” ì°½ì— ë“±ë¡ëœ Spring Security Filter Chain ì„ ì¶œë ¥í•˜ëŠ” ë°©ë²•ì´ë‹¤.
- `WebConfiguration` ì— `@EnableWebSecurity` ì–´ë…¸í…Œì´ì…˜ì˜ debug ì˜µì…˜ì„ trueë¡œ ë³€ê²½í•´ì¤€ë‹¤.

```java
@EnableWebSecurity(debug = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {

}
```

- ê·¸ë¦¬ê³  ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ê³  requestê°€ ë°œìƒí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥ëœë‹¤!

```java
Security filter chain: [
  WebAsyncManagerIntegrationFilter
  SecurityContextPersistenceFilter
  HeaderWriterFilter
  LogoutFilter
  EncodingFilter
  AuthenticationErrorFilter
  JwtAuthenticationFilter
  RequestCacheAwareFilter
  SecurityContextHolderAwareRequestFilter
  AnonymousAuthenticationFilter
  SessionManagementFilter
  ExceptionTranslationFilter
]
```

## UsernamePasswordAuthenticationToken

- ì¼ë°˜ì ìœ¼ë¡œ username, password í˜•ì‹ìœ¼ë¡œ ì¸ì¦ì„ í•˜ê¸° ë•Œë¬¸ì— ì£¼ë¡œ `Authentication` ì„ êµ¬í˜„í•œ `UsernamePasswordAuthenticationToken` ë¥¼ ì¸ì¦ ê°ì²´ë¡œ ì‚¬ìš©í•œë‹¤.

## AuthenticationProvider

- ì¸ì¦ ë¶€ë¶„ì„ ì»¤ìŠ¤í„°ë§ˆì´ì§• í•˜ë ¤ê³  í• ë•Œ `AuthenticationManager` ë¥¼ ì§ì ‘ êµ¬í˜„í•  ìˆ˜ë„ ìˆì§€ë§Œ ë³´í†µì€ `AuthenticationProvider` ë§Œ êµ¬í˜„í•˜ì—¬ ì‚¬ìš©í•œë‹¤.