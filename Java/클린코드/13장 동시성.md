# 13 장 동시성

## 동시성이 필요한 이유 ?

- 동시성은 결합을 없애는 전략이다. 
  - 무엇, 언제를 분리하는 전략
- 단일 스레드 프로그램은 무엇과 언제가 서로 밀접이다. 
- 무엇과 언제를 분리하면 App의 구조와 효율이 극적으로 나아진다. 
  - 프로그램은 거대한 루프 하나가 아니라 작은 협력 프로그램 여럿으로 보임. 
  - like 서블릿

## 동시성의 진실

- 동시성은 때로 성능을 높여준다.
  - 대기 시간이 아주 길어 여러 스레드가 프로세서를 공유할 수 있거나 
    여러 프로세서가 동시에 처리할 독립적 계산이 충분히 많은 경우에만 성능이 높아짐.

- 두 스레드가 같은 변수를 동시에 참조하는 경우 코드상으로는 한 줄이지만 정확히는 JIT 컴파일러가 바이트 코드를 처리하는 방식, 자바 메모리 모델이 원자로 간주하는 최소 단위에 따라서 경우의 수는 12,870개에 달함 ㅡㄴ 상황ㅇ

## 동시성 방어 원칙

- 단일 책임 원칙
  - 동시성 코드는 다른 코드와 분리하라ㅏ 
- 자료 범위를 제하라
  - 임계영역을 동기화 키워드로 보호함과 동시에 수를 줄여라
  - 자료를 캡슐화 하고 공유 자료를 최대한 줄여라.
- 자료 사본을 사용하라
  - 공유 자료를 줄이기 위해서 처음부터 공유하지 않는 방법이 제일 좋다. 
  - 객체의 사본을 읽기 전용으로 사용하는 방법이 가능함. 
- 스레드는 가능한 독립적으로 구현하라
  - 각 스레드는 클라이언트 요청 하나를 처리한다. 모든 정보는 로컬 변수에 저장한다.
  - ex) HttpServlet 클래스의 doGet doPost

## 라이브러리를 이해하라

- 자바 5부터 동시성 관련 기능들이 이전 버전보다 많이 나아졌다. 

### 스레드 환경에 안전한 컬렉션

- Java.util.concurrent 패키지가 제공하는 클래스는 다중 스레드 환경에서 사용해도 안전하며 성능도 좋다. 

  - 실제로 `ConcurrentHashMap` 은 거의 모든 상황에서 `HashMap` 보다 빠른다. 

- 언어가 제공하는 클래스를 검토하라.

  `atomic`, `locks`, `concurrent` 

## 동기화 하는 메서드 사이에 존재하는 의존성을 이해하라

- 공유 객체 하나에는 메서드 하나만 사용하라.