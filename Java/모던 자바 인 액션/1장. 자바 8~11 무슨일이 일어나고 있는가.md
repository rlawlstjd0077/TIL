# 1장. 자바 8~11 무슨일이 일어나고 있는가?

## 자바 8 설계의 밑바탕을 이루는 세 가지 프로그래밍 개념

### 1. 스트림 처리

- 스트림이란?

  - 한 번에 한 개씩 만들어지는 연속적인 데이터 항목들의 모임
  - 이론적으로 프로그램은 입력 스트림에서 데이터를 한개씩 읽어들어들이며 마찬가지로 출력 스트림으로 데이터를 한 개씩 기록함 
  - 일례로 유닉스나 리눅스의 많은 프로그램은 표준 입력에서 데이터를 읽은 후 데이터를 처리하고 표준 출력으로 기록함

- 예) 유닉스 명령행에서는 파이프 (`|`)을 이용해서 여러 명령을 연결할 수 있다.

  ```shell
  //파일의 단어를 소문자로 바꾼 다음에 사전순으로 단어를 정렬했을 때 가장 마지막에 위치한 세 단어를 출력하는 예제
  cat file1 file2 | tr "[A-Z]" "[a-z]" | sort | tail - 3
  ```

  - 유닉스에서는 여러 명령이 병렬로 실행되기 때문에 앞 명령이 완료되지 않은 시점에서 뒷 명령이 처리를 시작할 수 있음

- 자동차 생산 공장 라인에 비유할 수 있음

  - 여러 자동차로 구성된 스트림을 처리하는데, 각각의 작업장에서는 자동차를 받아 수리한 다음 다음 작업장으로 넘겨줌
  - 자동차는 물리적인 순서로 한개씩 운반이 되지만 각각의 작업장에서는 동시에 작업을 처리함 

- 자바 8에 `java.util.stream` 패키지에 스트림 API가 추가되었다. 

  - 스트림 패키지에 정의된 `Stream<T>`는 `T` 형식으로 구성된 일련의 항목을 의미함
  - 스트림 API는 파이프라인을 만드는 데 필요한 많은 메서드를 제공함

- 스트림 API의 핵심은 기존에는 한 번에 한 항목을 처리했지만 자바 8에서는 하려는 작업을 (DB 질의 처럼) 고수준으로 추상화해서 일련의 스트림으로 만들어 처리할 수 있다는 것이다.

  - 스트림 파이프라인을 이용해서 입력 부분을 여러 CPU 코어에 쉽게 할당할 수 있다는 부가적인 이득도 얻을 수 있음
  - 스레드라는 복잡한 작업을 사용하지 않으면서도 공짜로 병렬성을 얻을 수 있음

### 2. 동작 파라미터화로 메서드에 코드 전달하기

- 코드 일부를 API로 전달하는 기능
  - 자바 8 이전의 자바에서는 메서드를 다른 메서드로 전달할 방법이 없었음
- 자바 8에서는 메서드(작성한 코드)를 다른 메서드의 인수로 넘겨주는 기능을 제공한다.
- 이러한 기능을 이론적으로 **동작 파라미터화**하고 부른다. 
  - 동작 파라미터화가 중요한 이유는 스트림 API의 연산의 동작을 파라미터화할 수 있는 코드를 전달한다는 사상에 기초하기 때문

### 3. 병렬성과 공유 가변 데이터

- ''병렬성을 공짜로 얻을 수 있다' 라는 말에서 시작된다.
  - 단, 병렬성을 얻는 대신 스트림 메서드로 전달하는 코드의 동작 방식을 조금 바꿔줘야 함
- 스트림 메서드로 전달하는 코드는 다른 코드와 동시에 실행하더라도 안전하게 실행될 수 있어야 한다.
  - 보통 다른 코드와 동시에 실행 하더라도 **안전하게 실행**할 수 있는 코드를 만들려면 공유된 가변 데이터에 접근하지 않아야 함
  - 위와 같은 함수를 순수함수, 부작용 없는 함수, 상태 없는 함수라 부름
- 자바 8 스트림을 이용하면 기존의 자바 스레드 API보다 쉽게 병렬성을 활용할 수 있다. 
  - 다중 프로세싱 코어에서 `synchronized`를 사용하면 생각보다 훨씬 더 비싼 대가를 치러야 할 수 있음

## 자바 함수

- 프로그래밍 언어의 핵심은 값을 바꾸는 것이다
  - 역사적으로 프로그래밍 언어에서는 이 값을 일급값(또는 시민, 1960년대 미국 시민 권리에서 유래)라고 부름
- 자바 프로그래밍 언어의 다양한 구조체(메서드, 클래스 같은)가 값을 구조를 표현하는 데 도움이 될 수 있다.
  - 하지만 프로그램 실행동안 모든 구조체를 자유롭게 전달 할 수는 없음
  - 따라서 이런 메서드, 클래스 등은 이급 자바 시민에 해당함
- 자바 8 설계자들은 이급 시민을 일급 시민으로 바꿀 수 있는 기능을 추가했다. 
  - 이미 스몰토크, 자바스크립트 같은 다양한 언어에서 일급 시민으로 가득 찬 세계를 성공적으로 만들어 가고 있음

### 메서드와 람다를 일급 시민으로

- 스칼라와 그루비 같은 언어에서 메서드를 일급값으로 사용하면 프로그래머가 활용할 수 있는 도구가 다양해지면서 프로그래밍이 수월해진다는 사실을 이미 실험을 통해 확인했다.
- 따라서 자바 8 설계자들은 메서드를 값으로 취급할 수 있게, 프로그래머들이 더 쉽게 프로그램을 구현할 수 있는 환경이 제공되도록 자바 8을 설계하기로 결정하였다. 

### 메서드 전달에서 람다로

- 멀티코어 CPU가 아니었다면 원래 자바 8 설계자들의 계획은 여기까지(람다, 메서드 참조) 였을 것이다.
  - 아마도 자바는 `filter` 그리고 몇몇 일반적인 라이브러리 메서드를 추가하는 방향으로 발전했을 수도 있음
- 하지만 병렬성이라는 중요성 때문에 설계자들은 위와 같은 설계를 포기했다.
  - 자바 8에서는 연산집합을 포함하는 새로운 스트림 API를 제공함
  - 컬렉션과 스트림 간에 변환할 수 있는 메서드(map, reduce등)도 제공함

## 스트림

- 거의 모든 자바 애플리케이션은 컬렉션을 **만들고 활용**한다. 
  - 하지만 컬렉션으로 모든 문제가 해결되는 것은 아니다.
- 컬렉션에서는 반복 과정을 직접처리해야 했다. 
  - `for-each` 루프를 이용해서 요소를 반복하면서 작업을 수행
  - 이런 방식의 반복을 **외부 반복**이라고 함
- 스트림 API를 이용하면 루프를 신경쓸 필요가 없다.
  - 스트림 API 내부에서 모든 데이터가 처리됨
  - 이런 방식의 반복을 **내부 반복**이라고 함

### 멀티스레딩은 어렵다

- 이전 자바 버전에서 제공하는 스레드 API로 **멀티스레딩** 코드를 구현해서 병렬성을 이용하는 것은 쉽지 않다.
- 자바 8은 스트림 API로 '컬렉션을 처리하면서 발생하는 모호함과 반복적인 코드 문제'와 '멀티 코어 활용 어려움' 이라는 두 가지 문제를 해결했다. 
  - 기존 컬렉션에서 데이터를 처리할 때 반복되는 패턴을 라이브러리에서 제공하면 좋을 것이라는 아이디어가 변화의 동기가 되었음
- 자주 사용되는 반복 패턴
  - 주어진 조건에 따라 데이터를 **필터링**하거나, 데이터를 **추출**, 데이터를 **그룹화**등
  - 또한 이러한 동작들을 쉽게 병렬화할 수 있다는 점도 변화의 동기가 됨
- 컬렉션은 어떻게 데이터를 저장하고 접근할 것인지에 중점을 두는 반면 **스트림은 어떤 계산을 할 것인지 묘사하는 것**에 대해 중점을 둠

#### 자바 병렬성과 공유되지 않은 가변 상태

- 자바 8은 우선 라이브러리에서 분할을 처리한다.
  - 큰 스트림을 병렬로 처리할 수 있도록 작은 스트림으로 분할함
  - `filter` 같은 라이브러리 메서드로 전달된 메서드가 상호작용을 하지 않는다면가변 공유 객체를 통해 공짜로 병렬성을 누릴 수 있음
- 상호작용을 하지 않는다는 제약은 프로그래머 입장에서 상당히 자연스러운 일이다. (예. `Apple::isGreenApple`)
- 함수형 프로그래밍에서 함수형이란 '함수를 일급값으로 사용한다'라는 의미도 있지만 ''프로그램이 실행되는 동안 컴포넌트 간에 상호 작용이 일어나지 않는다'라는 의미도 포함함

## 디폴트 메서드와 자바 모듈

- 요즘은 외부에서 만들어진 컴포넌트를 이용해 시스템을 구축하는 경향이 있다. 
  - 이전에는 패키지의 인터페이스를 바꿔야 하는 상황에서는 인터페이스를 구현하는 모든 클래스의 구현을 바꿔야 했으므로 여간 고통 스러운 작업이 아니었음

